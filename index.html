.dark-mode .disclaimer-backdrop {
            background: rgba(0, 0, 0, 0.9);
        }        /* Link styling for buttons */
        a.btn {
            text-decoration: none;
        }
        
        a.btn:hover {
            text-decoration: none;
        }
        
        /* General link styling */
        a {
            color: var(--primary);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }        .sheet-close-button {
            background: rgba(107, 114, 128, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark);
        }

        .sheet-close-button:hover {
            background: rgba(107, 114, 128, 0.2);
        }

        .dark-mode .sheet-close-button {
            background: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }

        .dark-mode .sheet-close-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <title>Sagre in Umbria 2025 - Mappa Interattiva</title>
    <meta name="description" content="Scopri tutte le sagre e feste gastronomiche in Umbria 2025. Mappa interattiva con filtri, preferiti e localizzazione GPS.">
    
    <!-- Language alternates for SEO -->
    <link rel="alternate" hreflang="it" href="#it" />
    <link rel="alternate" hreflang="en" href="#en" />
    <link rel="alternate" hreflang="nl" href="#nl" />
    <link rel="alternate" hreflang="de" href="#de" />
    <link rel="alternate" hreflang="fr" href="#fr" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --radius: 16px;
            --radius-sm: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
            position: relative;
            height: 100vh;
        }

        /* Dark mode styles */
        body.dark-mode {
            --dark: #f9fafb;
            --light: #1f2937;
            --gray: #9ca3af;
            background: #111827;
        }

        .dark-mode .header {
            background: #1f2937;
        }

        .dark-mode .bottom-nav {
            background: #1f2937;
            border-top-color: #374151;
        }

        .dark-mode .filter-sheet {
            background: #1f2937;
        }

        .dark-mode .sheet-header {
            border-bottom-color: #374151;
        }

        .dark-mode .list-card {
            background: #374151;
        }

        .dark-mode .lang-dropdown {
            background: #374151;
        }

        .dark-mode .lang-dropdown button:hover {
            background: #4b5563;
        }

        /* Dark mode form inputs */
        .dark-mode .search-input,
        .dark-mode .date-input {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .search-input:focus,
        .dark-mode .date-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .dark-mode .search-input::placeholder {
            color: #9ca3af;
        }

        /* Dark mode date picker fix */
        .dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }

        .dark-mode input[type="date"]::-webkit-datetime-edit-text,
        .dark-mode input[type="date"]::-webkit-datetime-edit-month-field,
        .dark-mode input[type="date"]::-webkit-datetime-edit-day-field,
        .dark-mode input[type="date"]::-webkit-datetime-edit-year-field {
            color: #f9fafb;
        }

        /* Dark mode chips */
        .dark-mode .chip {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }

        .dark-mode .chip:hover {
            background: #4b5563;
        }

        .dark-mode .chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Dark mode buttons */
        .dark-mode .btn-secondary {
            background: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .btn-secondary:hover {
            background: #6b7280;
        }
        
        /* Ensure good contrast in popup buttons */
        .popup-actions .btn-secondary {
            background: #e5e7eb;
            color: #1f2937;
            font-weight: 500;
            border: 1px solid transparent;
        }
        
        .popup-actions .btn-secondary:hover {
            background: #d1d5db;
            border-color: #9ca3af;
        }
        
        .dark-mode .popup-actions .btn-secondary {
            background: #4b5563;
            color: #f9fafb;
            border: 1px solid #6b7280;
        }
        
        .dark-mode .popup-actions .btn-secondary:hover {
            background: #6b7280;
            border-color: #9ca3af;
        }

        /* Dark mode popup */
        .dark-mode .leaflet-popup-content-wrapper {
            background: #374151;
            color: #f9fafb;
        }

        .dark-mode .leaflet-popup-tip {
            background: #374151;
        }

        .dark-mode .popup-body {
            background: #374151;
        }

        /* Dark mode toast */
        .dark-mode .toast {
            background: #374151;
            color: #f9fafb;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .icon-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .icon-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .dark-mode .header .icon-button {
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .header .icon-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        .lang-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .lang-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            color: var(--dark);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            min-width: 150px;
            z-index: 1001;
        }

        .lang-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-dropdown button {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--dark);
            font-size: 0.875rem;
        }

        .lang-dropdown button:hover {
            background: var(--light);
        }

        .lang-dropdown button.active {
            background: var(--primary);
            color: white;
        }

        .dark-mode .lang-dropdown button.active {
            background: var(--primary);
            color: white;
        }

        /* Main content area */
        .content {
            position: fixed;
            top: 60px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow: hidden;
        }

        /* Map container */
        #map {
            height: 100%;
            width: 100%;
            transition: opacity 0.3s ease;
        }

        /* List view */
        .list-view {
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .list-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .list-card {
            background: white;
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .list-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .list-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .list-card.favorite::before {
            background: var(--secondary);
        }

        .list-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .list-card h3 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .list-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .list-card-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .list-card-food {
            font-style: italic;
            color: var(--success);
            font-size: 0.875rem;
        }

        .favorite-button {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            padding: 0.25rem;
        }

        .favorite-button:hover {
            transform: scale(1.2);
        }

        .favorite-button.active {
            color: var(--secondary);
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: none;
            border: none;
            color: var(--gray);
            text-decoration: none;
            position: relative;
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .nav-item span {
            font-size: 0.75rem;
        }

        .nav-badge {
            position: absolute;
            top: 0;
            right: 25%;
            background: var(--secondary);
            color: white;
            font-size: 0.625rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 999;
        }

        .fab-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
        }

        .fab-button:hover {
            transform: scale(1.05);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.2);
        }

        .fab-button:active {
            transform: scale(0.95);
        }

        .fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--secondary);
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Filter Sheet (Bottom Sheet) */
        .filter-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--radius) var(--radius) 0 0;
            box-shadow: var(--shadow-lg);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            max-height: 80vh;
            overflow-y: auto;
        }

        .filter-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 0.75rem auto;
        }

        .dark-mode .sheet-handle {
            background: #4b5563;
        }

        .sheet-header {
            padding: 0 1.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
        }

        .dark-mode .sheet-header h2 {
            color: #f9fafb;
        }

        .sheet-content {
            padding: 1.5rem;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .dark-mode .filter-section label {
            color: #f9fafb;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .location-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .location-input-group input {
            flex: 1;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Food category chips */
        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .chip {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: #f3f4f6;
            border: 2px solid transparent;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chip:hover {
            background: #e5e7eb;
        }

        .chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Date range picker */
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .date-input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .dark-mode .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-card {
            height: 120px;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }

        .popup-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .popup-header h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .popup-location {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .popup-body {
            padding: 1rem;
        }

        .popup-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .popup-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .popup-actions {
            display: flex;
            gap: 0.5rem;
        }

        .popup-actions .btn {
            flex: 1;
            font-size: 0.875rem;
            padding: 0.5rem;
            text-decoration: none;
            text-align: center;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 3000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .content {
                top: 70px;
            }
            
            .filter-sheet {
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%) translateY(100%);
                border-radius: var(--radius);
                margin-bottom: 1rem;
            }
            
            .filter-sheet.active {
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Backdrop for filter sheet */
        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1999;
        }

        .backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .dark-mode .backdrop {
            background: rgba(0, 0, 0, 0.7);
        }

        /* No results state */
        .no-results {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray);
        }

        .no-results svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .dark-mode .no-results {
            color: #9ca3af;
        }

        .dark-mode .no-results svg {
            opacity: 0.3;
        }
        /* Disclaimer Modal */
        .disclaimer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .disclaimer-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .disclaimer-modal {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .disclaimer-backdrop.active .disclaimer-modal {
            transform: scale(1) translateY(0);
        }

        .dark-mode .disclaimer-modal {
            background: #1f2937;
            color: #f9fafb;
        }

        .disclaimer-modal h2 {
            margin: 0 0 1rem 0;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .dark-mode .disclaimer-modal h2 {
            color: #a5b4fc;
        }

        .disclaimer-modal p {
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: var(--gray);
        }

        .disclaimer-modal p a {
            color: var(--primary);
            text-decoration: underline;
        }

        .disclaimer-modal p a:hover {
            color: var(--primary-dark);
        }

        .dark-mode .disclaimer-modal p {
            color: #d1d5db;
        }

        .dark-mode .disclaimer-modal p a {
            color: #a5b4fc;
        }

        .dark-mode .disclaimer-modal p a:hover {
            color: #c7d2fe;
        }

        .disclaimer-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        @media (max-width: 480px) {
            .disclaimer-modal {
                padding: 1.5rem;
            }
            
            .disclaimer-actions {
                flex-direction: column;
            }
            
            .disclaimer-actions .btn {
                width: 100%;
            }
        }

        /* Info button in header */
        .info-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .info-button svg {
            width: 20px;
            height: 20px;
        }

        .info-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .dark-mode .header .info-button {
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .header .info-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Header -->
    <header class="header">
        <h1 data-i18n="header.title">🎪 Sagre Umbria 2025</h1>
        <div class="header-actions">
            <button class="info-button" onclick="showDisclaimer()" data-i18n-aria="header.info" data-i18n-title="header.info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="11"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
            </button>
            <div class="language-selector">
                <button class="lang-button" onclick="toggleLanguageMenu()" aria-label="Change language">
                    <span id="currentLangFlag">🇮🇹</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="lang-dropdown" id="langDropdown">
                    <button onclick="changeLanguage('it')">🇮🇹 Italiano</button>
                    <button onclick="changeLanguage('en')">🇬🇧 English</button>
                    <button onclick="changeLanguage('nl')">🇳🇱 Nederlands</button>
                    <button onclick="changeLanguage('de')">🇩🇪 Deutsch</button>
                    <button onclick="changeLanguage('fr')">🇫🇷 Français</button>
                </div>
            </div>
            <button class="icon-button" onclick="toggleDarkMode()" data-i18n-aria="header.darkModeToggle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main content -->
    <div class="content">
        <!-- Map View -->
        <div id="map"></div>
        
        <!-- List View -->
        <div class="list-view" id="listView">
            <div id="listContent">
                <!-- List items will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showView('map')" id="navMap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
            <span data-i18n="nav.map">Mappa</span>
        </button>
        <button class="nav-item" onclick="showView('list')" id="navList">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            <span data-i18n="nav.list">Lista</span>
        </button>
        <button class="nav-item" onclick="showView('favorites')" id="navFavorites">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span data-i18n="nav.favorites">Preferiti</span>
            <span class="nav-badge" id="favoritesCount" style="display: none;">0</span>
        </button>
        <button class="nav-item" onclick="showNearMe()" id="navNearMe">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
            </svg>
            <span data-i18n="nav.nearMe">Vicino a me</span>
        </button>
    </nav>

    <!-- Floating Action Button -->
    <div class="fab">
        <button class="fab-button" onclick="toggleFilterSheet()" data-i18n-aria="filters.openFilters">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            <span class="fab-badge" id="filterBadge" style="display: none;">0</span>
        </button>
    </div>

    <!-- Filter Sheet -->
    <div class="backdrop" id="backdrop" onclick="closeFilterSheet()"></div>
    <div class="filter-sheet" id="filterSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">
            <h2 data-i18n="filters.title">Filtri di ricerca</h2>
            <button class="sheet-close-button" onclick="closeFilterSheet()" aria-label="Close filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="sheet-content">
            <!-- Search -->
            <div class="filter-section">
                <label for="searchInput" data-i18n="filters.search">Cerca sagra</label>
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       data-i18n-placeholder="filters.searchPlaceholder"
                       placeholder="Nome, località, specialità..."
                       oninput="handleSearch(this.value)">
            </div>

            <!-- Location -->
            <div class="filter-section">
                <label for="locationInput" data-i18n="filters.myLocation">La mia posizione</label>
                <div class="location-input-group">
                    <input type="text" 
                           id="locationInput" 
                           class="search-input" 
                           data-i18n-placeholder="filters.locationPlaceholder"
                           placeholder="es. Perugia, Assisi, Todi...">
                    <button class="btn btn-primary btn-icon" onclick="setUserLocation()" data-i18n-aria="filters.setLocation">
                        📍
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="useGPS()" data-i18n-aria="filters.useGPS">
                        📡
                    </button>
                </div>
            </div>

            <!-- Food Categories -->
            <div class="filter-section">
                <label data-i18n="filters.categories">Categorie di cibo</label>
                <div class="category-chips" id="categoryChips">
                    <div class="chip" data-category="pasta" onclick="toggleCategory(this)">
                        <span data-i18n="categories.pasta">🍝 Pasta</span>
                    </div>
                    <div class="chip" data-category="carne" onclick="toggleCategory(this)">
                        <span data-i18n="categories.meat">🥩 Carne</span>
                    </div>
                    <div class="chip" data-category="pesce" onclick="toggleCategory(this)">
                        <span data-i18n="categories.fish">🐟 Pesce</span>
                    </div>
                    <div class="chip" data-category="dolci" onclick="toggleCategory(this)">
                        <span data-i18n="categories.desserts">🍰 Dolci</span>
                    </div>
                    <div class="chip" data-category="verdure" onclick="toggleCategory(this)">
                        <span data-i18n="categories.vegetables">🥗 Verdure</span>
                    </div>
                    <div class="chip" data-category="formaggi" onclick="toggleCategory(this)">
                        <span data-i18n="categories.cheese">🧀 Formaggi</span>
                    </div>
                    <div class="chip" data-category="vino" onclick="toggleCategory(this)">
                        <span data-i18n="categories.wine">🍷 Vino</span>
                    </div>
                    <div class="chip" data-category="altro" onclick="toggleCategory(this)">
                        <span data-i18n="categories.other">🍽️ Altro</span>
                    </div>
                </div>
            </div>

            <!-- Date Range -->
            <div class="filter-section">
                <label data-i18n="filters.period">Periodo</label>
                <div class="date-range">
                    <input type="date" 
                           id="dateFrom" 
                           class="date-input" 
                           min="2025-07-01" 
                           max="2025-10-31"
                           onchange="updateDateFilter()">
                    <input type="date" 
                           id="dateTo" 
                           class="date-input" 
                           min="2025-07-01" 
                           max="2025-10-31"
                           onchange="updateDateFilter()">
                </div>
            </div>

            <!-- Actions -->
            <div class="filter-section">
                <button class="btn btn-primary btn-block" onclick="applyFilters()" data-i18n="filters.apply">
                    Applica filtri
                </button>
                <button class="btn btn-secondary btn-block" onclick="resetFilters()" style="margin-top: 0.5rem;" data-i18n="filters.reset">
                    Reimposta filtri
                </button>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div class="disclaimer-backdrop" id="disclaimerBackdrop">
        <div class="disclaimer-modal">
            <h2 data-i18n="disclaimer.title">Informazioni importanti</h2>
            <p data-i18n-html="disclaimer.text">
                Questo è un progetto personale che utilizza dati da Umbria Eventi (<a href="https://www.umbriaeventi.com/sagre-umbria.htm" target="_blank">https://www.umbriaeventi.com/sagre-umbria.htm</a>). 
                L'intento è di rendere più facile per me trovare sagre quando sono in Italia. 
                Se lo trovi utile, ottimo, ma non è in alcun modo inteso a deviare traffico dal loro sito web.
            </p>
            <div class="disclaimer-actions">
                <a href="https://www.umbriaeventi.com/sagre-umbria.htm" target="_blank" class="btn btn-secondary" data-i18n="disclaimer.visitSource">
                    Visita Umbria Eventi
                </a>
                <button class="btn btn-primary" onclick="closeDisclaimer()" data-i18n="disclaimer.ok">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script>
        // Translation data
        const translations = {
            it: {
                header: {
                    title: "🎪 Sagre Umbria 2025",
                    darkModeToggle: "Attiva/disattiva modalità scura",
                    info: "Informazioni"
                },
                nav: {
                    map: "Mappa",
                    list: "Lista",
                    favorites: "Preferiti",
                    nearMe: "Vicino a me"
                },
                filters: {
                    title: "Filtri di ricerca",
                    search: "Cerca sagra",
                    searchPlaceholder: "Nome, località, specialità...",
                    myLocation: "La mia posizione",
                    locationPlaceholder: "es. Perugia, Assisi, Todi...",
                    categories: "Categorie di cibo",
                    period: "Periodo",
                    apply: "Applica filtri",
                    reset: "Reimposta filtri",
                    openFilters: "Apri filtri",
                    setLocation: "Imposta posizione",
                    useGPS: "Usa GPS"
                },
                categories: {
                    pasta: "🍝 Pasta",
                    meat: "🥩 Carne",
                    fish: "🐟 Pesce",
                    desserts: "🍰 Dolci",
                    vegetables: "🥗 Verdure",
                    cheese: "🧀 Formaggi",
                    wine: "🍷 Vino",
                    other: "🍽️ Altro"
                },
                common: {
                    fromYourLocation: "dalla tua posizione",
                    noResults: "Nessuna sagra trovata",
                    noFavorites: "Nessun preferito salvato",
                    days: "giorni",
                    today: "oggi",
                    tomorrow: "domani",
                    loading: "Caricamento..."
                },
                actions: {
                    addToFavorites: "❤️ Preferiti",
                    removeFromFavorites: "💔 Rimuovi",
                    moreInfo: "Info",
                    getDirections: "Indicazioni"
                },
                toast: {
                    addedToFavorites: "Aggiunto ai preferiti",
                    removedFromFavorites: "Rimosso dai preferiti",
                    locationSet: "Posizione impostata",
                    locationNotFound: "Città non trovata. Prova con Perugia, Assisi, Todi...",
                    enterCity: "Inserisci una città",
                    detectingLocation: "Rilevamento posizione GPS...",
                    locationDetected: "Posizione rilevata",
                    locationError: "Errore nel rilevamento posizione",
                    geolocationNotSupported: "Geolocalizzazione non supportata",
                    darkModeOn: "Modalità scura attivata",
                    darkModeOff: "Modalità chiara attivata",
                    resultsFound: "sagre trovate"
                },
                disclaimer: {
                    title: "Informazioni importanti",
                    text: "Questo è un progetto personale che utilizza dati da Umbria Eventi (<a href=\"https://www.umbriaeventi.com/sagre-umbria.htm\" target=\"_blank\">https://www.umbriaeventi.com/sagre-umbria.htm</a>). L'intento è di rendere più facile per me trovare sagre quando sono in Italia. Se lo trovi utile, ottimo, ma non è in alcun modo inteso a deviare traffico dal loro sito web.",
                    visitSource: "Visita Umbria Eventi",
                    ok: "OK"
                }
            },
            en: {
                header: {
                    title: "🎪 Umbria Food Festivals 2025",
                    darkModeToggle: "Toggle dark mode",
                    info: "Information"
                },
                nav: {
                    map: "Map",
                    list: "List",
                    favorites: "Favorites",
                    nearMe: "Near me"
                },
                filters: {
                    title: "Search filters",
                    search: "Search festival",
                    searchPlaceholder: "Name, location, specialty...",
                    myLocation: "My location",
                    locationPlaceholder: "e.g. Perugia, Assisi, Todi...",
                    categories: "Food categories",
                    period: "Period",
                    apply: "Apply filters",
                    reset: "Reset filters",
                    openFilters: "Open filters",
                    setLocation: "Set location",
                    useGPS: "Use GPS"
                },
                categories: {
                    pasta: "🍝 Pasta",
                    meat: "🥩 Meat",
                    fish: "🐟 Fish",
                    desserts: "🍰 Desserts",
                    vegetables: "🥗 Vegetables",
                    cheese: "🧀 Cheese",
                    wine: "🍷 Wine",
                    other: "🍽️ Other"
                },
                common: {
                    fromYourLocation: "from your location",
                    noResults: "No festivals found",
                    noFavorites: "No favorites saved",
                    days: "days",
                    today: "today",
                    tomorrow: "tomorrow",
                    loading: "Loading..."
                },
                actions: {
                    addToFavorites: "❤️ Favorite",
                    removeFromFavorites: "💔 Remove",
                    moreInfo: "Info",
                    getDirections: "Directions"
                },
                toast: {
                    addedToFavorites: "Added to favorites",
                    removedFromFavorites: "Removed from favorites",
                    locationSet: "Location set",
                    locationNotFound: "City not found. Try Perugia, Assisi, Todi...",
                    enterCity: "Enter a city",
                    detectingLocation: "Detecting GPS location...",
                    locationDetected: "Location detected",
                    locationError: "Error detecting location",
                    geolocationNotSupported: "Geolocation not supported",
                    darkModeOn: "Dark mode activated",
                    darkModeOff: "Light mode activated",
                    resultsFound: "festivals found"
                },
                disclaimer: {
                    title: "Important Information",
                    text: "This is a personal project that uses data from Umbria Eventi (<a href=\"https://www.umbriaeventi.com/sagre-umbria.htm\" target=\"_blank\">https://www.umbriaeventi.com/sagre-umbria.htm</a>). The intent is to make it easier for me to find festivals when in Italy. If you find it useful, great, but it is in no way intended to divert traffic from their website.",
                    visitSource: "Visit Umbria Eventi",
                    ok: "OK"
                }
            },
            nl: {
                header: {
                    title: "🎪 Umbrië Eetfestivals 2025",
                    darkModeToggle: "Donkere modus in-/uitschakelen",
                    info: "Informatie"
                },
                nav: {
                    map: "Kaart",
                    list: "Lijst",
                    favorites: "Favorieten",
                    nearMe: "In de buurt"
                },
                filters: {
                    title: "Zoekfilters",
                    search: "Zoek festival",
                    searchPlaceholder: "Naam, locatie, specialiteit...",
                    myLocation: "Mijn locatie",
                    locationPlaceholder: "bijv. Perugia, Assisi, Todi...",
                    categories: "Voedselcategorieën",
                    period: "Periode",
                    apply: "Filters toepassen",
                    reset: "Filters resetten",
                    openFilters: "Filters openen",
                    setLocation: "Locatie instellen",
                    useGPS: "Gebruik GPS"
                },
                categories: {
                    pasta: "🍝 Pasta",
                    meat: "🥩 Vlees",
                    fish: "🐟 Vis",
                    desserts: "🍰 Desserts",
                    vegetables: "🥗 Groenten",
                    cheese: "🧀 Kaas",
                    wine: "🍷 Wijn",
                    other: "🍽️ Overig"
                },
                common: {
                    fromYourLocation: "vanaf uw locatie",
                    noResults: "Geen festivals gevonden",
                    noFavorites: "Geen favorieten opgeslagen",
                    days: "dagen",
                    today: "vandaag",
                    tomorrow: "morgen",
                    loading: "Laden..."
                },
                actions: {
                    addToFavorites: "❤️ Favoriet",
                    removeFromFavorites: "💔 Verwijder",
                    moreInfo: "Info",
                    getDirections: "Route"
                },
                toast: {
                    addedToFavorites: "Toegevoegd aan favorieten",
                    removedFromFavorites: "Verwijderd uit favorieten",
                    locationSet: "Locatie ingesteld",
                    locationNotFound: "Stad niet gevonden. Probeer Perugia, Assisi, Todi...",
                    enterCity: "Voer een stad in",
                    detectingLocation: "GPS-locatie detecteren...",
                    locationDetected: "Locatie gedetecteerd",
                    locationError: "Fout bij detecteren locatie",
                    geolocationNotSupported: "Geolocatie niet ondersteund",
                    darkModeOn: "Donkere modus geactiveerd",
                    darkModeOff: "Lichte modus geactiveerd",
                    resultsFound: "festivals gevonden"
                },
                disclaimer: {
                    title: "Belangrijke informatie",
                    text: "Dit is een persoonlijk project dat gegevens gebruikt van Umbria Eventi (<a href=\"https://www.umbriaeventi.com/sagre-umbria.htm\" target=\"_blank\">https://www.umbriaeventi.com/sagre-umbria.htm</a>). Het doel is om het voor mij gemakkelijker te maken om festivals te vinden wanneer ik in Italië ben. Als je het nuttig vindt, geweldig, maar het is op geen enkele manier bedoeld om verkeer van hun website af te leiden.",
                    visitSource: "Bezoek Umbria Eventi",
                    ok: "OK"
                }
            },
            de: {
                header: {
                    title: "🎪 Umbrien Volksfeste 2025",
                    darkModeToggle: "Dunkelmodus umschalten",
                    info: "Information"
                },
                nav: {
                    map: "Karte",
                    list: "Liste",
                    favorites: "Favoriten",
                    nearMe: "In der Nähe"
                },
                filters: {
                    title: "Suchfilter",
                    search: "Festival suchen",
                    searchPlaceholder: "Name, Ort, Spezialität...",
                    myLocation: "Mein Standort",
                    locationPlaceholder: "z.B. Perugia, Assisi, Todi...",
                    categories: "Lebensmittelkategorien",
                    period: "Zeitraum",
                    apply: "Filter anwenden",
                    reset: "Filter zurücksetzen",
                    openFilters: "Filter öffnen",
                    setLocation: "Standort festlegen",
                    useGPS: "GPS verwenden"
                },
                categories: {
                    pasta: "🍝 Pasta",
                    meat: "🥩 Fleisch",
                    fish: "🐟 Fisch",
                    desserts: "🍰 Desserts",
                    vegetables: "🥗 Gemüse",
                    cheese: "🧀 Käse",
                    wine: "🍷 Wein",
                    other: "🍽️ Sonstiges"
                },
                common: {
                    fromYourLocation: "von Ihrem Standort",
                    noResults: "Keine Festivals gefunden",
                    noFavorites: "Keine Favoriten gespeichert",
                    days: "Tage",
                    today: "heute",
                    tomorrow: "morgen",
                    loading: "Laden..."
                },
                actions: {
                    addToFavorites: "❤️ Favorit",
                    removeFromFavorites: "💔 Entfernen",
                    moreInfo: "Info",
                    getDirections: "Wegbeschreibung"
                },
                toast: {
                    addedToFavorites: "Zu Favoriten hinzugefügt",
                    removedFromFavorites: "Aus Favoriten entfernt",
                    locationSet: "Standort festgelegt",
                    locationNotFound: "Stadt nicht gefunden. Versuchen Sie Perugia, Assisi, Todi...",
                    enterCity: "Stadt eingeben",
                    detectingLocation: "GPS-Standort wird ermittelt...",
                    locationDetected: "Standort erkannt",
                    locationError: "Fehler beim Ermitteln des Standorts",
                    geolocationNotSupported: "Geolokalisierung nicht unterstützt",
                    darkModeOn: "Dunkelmodus aktiviert",
                    darkModeOff: "Hellmodus aktiviert",
                    resultsFound: "Festivals gefunden"
                },
                disclaimer: {
                    title: "Wichtige Informationen",
                    text: "Dies ist ein persönliches Projekt, das Daten von Umbria Eventi (<a href=\"https://www.umbriaeventi.com/sagre-umbria.htm\" target=\"_blank\">https://www.umbriaeventi.com/sagre-umbria.htm</a>) verwendet. Die Absicht ist, es mir zu erleichtern, Volksfeste zu finden, wenn ich in Italien bin. Wenn Sie es nützlich finden, großartig, aber es ist in keiner Weise dazu gedacht, Verkehr von deren Website abzulenken.",
                    visitSource: "Umbria Eventi besuchen",
                    ok: "OK"
                }
            },
            fr: {
                header: {
                    title: "🎪 Festivals Gastronomiques Ombrie 2025",
                    darkModeToggle: "Basculer le mode sombre",
                    info: "Informations"
                },
                nav: {
                    map: "Carte",
                    list: "Liste",
                    favorites: "Favoris",
                    nearMe: "Près de moi"
                },
                filters: {
                    title: "Filtres de recherche",
                    search: "Rechercher un festival",
                    searchPlaceholder: "Nom, lieu, spécialité...",
                    myLocation: "Ma position",
                    locationPlaceholder: "ex. Pérouse, Assise, Todi...",
                    categories: "Catégories alimentaires",
                    period: "Période",
                    apply: "Appliquer les filtres",
                    reset: "Réinitialiser les filtres",
                    openFilters: "Ouvrir les filtres",
                    setLocation: "Définir la position",
                    useGPS: "Utiliser le GPS"
                },
                categories: {
                    pasta: "🍝 Pâtes",
                    meat: "🥩 Viande",
                    fish: "🐟 Poisson",
                    desserts: "🍰 Desserts",
                    vegetables: "🥗 Légumes",
                    cheese: "🧀 Fromage",
                    wine: "🍷 Vin",
                    other: "🍽️ Autre"
                },
                common: {
                    fromYourLocation: "depuis votre position",
                    noResults: "Aucun festival trouvé",
                    noFavorites: "Aucun favori enregistré",
                    days: "jours",
                    today: "aujourd'hui",
                    tomorrow: "demain",
                    loading: "Chargement..."
                },
                actions: {
                    addToFavorites: "❤️ Favori",
                    removeFromFavorites: "💔 Retirer",
                    moreInfo: "Info",
                    getDirections: "Itinéraire"
                },
                toast: {
                    addedToFavorites: "Ajouté aux favoris",
                    removedFromFavorites: "Retiré des favoris",
                    locationSet: "Position définie",
                    locationNotFound: "Ville introuvable. Essayez Pérouse, Assise, Todi...",
                    enterCity: "Entrez une ville",
                    detectingLocation: "Détection de la position GPS...",
                    locationDetected: "Position détectée",
                    locationError: "Erreur lors de la détection de la position",
                    geolocationNotSupported: "Géolocalisation non prise en charge",
                    darkModeOn: "Mode sombre activé",
                    darkModeOff: "Mode clair activé",
                    resultsFound: "festivals trouvés"
                },
                disclaimer: {
                    title: "Informations importantes",
                    text: "Il s'agit d'un projet personnel qui utilise des données d'Umbria Eventi (<a href=\"https://www.umbriaeventi.com/sagre-umbria.htm\" target=\"_blank\">https://www.umbriaeventi.com/sagre-umbria.htm</a>). L'objectif est de me faciliter la recherche de festivals lorsque je suis en Italie. Si vous le trouvez utile, tant mieux, mais il n'est en aucun cas destiné à détourner du trafic de leur site web.",
                    visitSource: "Visiter Umbria Eventi",
                    ok: "OK"
                }
            }
        };

        // Language Manager Class
        class LanguageManager {
            constructor() {
                this.languages = {
                    it: { name: 'Italiano', flag: '🇮🇹' },
                    en: { name: 'English', flag: '🇬🇧' },
                    nl: { name: 'Nederlands', flag: '🇳🇱' },
                    de: { name: 'Deutsch', flag: '🇩🇪' },
                    fr: { name: 'Français', flag: '🇫🇷' }
                };
                
                this.currentLang = this.detectUserLanguage();
                this.updatePageLanguage();
            }
            
            detectUserLanguage() {
                const saved = localStorage.getItem('app-language');
                if (saved && this.languages[saved]) return saved;
                
                const browserLang = navigator.language.toLowerCase();
                const supportedLangs = Object.keys(this.languages);
                
                // Check exact match
                if (supportedLangs.includes(browserLang)) {
                    return browserLang;
                }
                
                // Check language code (e.g., 'en-US' -> 'en')
                const langCode = browserLang.split('-')[0];
                if (supportedLangs.includes(langCode)) {
                    return langCode;
                }
                
                // Default to Italian
                return 'it';
            }
            
            get(key, replacements = {}) {
                const keys = key.split('.');
                let value = translations[this.currentLang];
                
                for (const k of keys) {
                    value = value?.[k];
                    if (!value) {
                        // Fallback to Italian
                        value = translations['it'];
                        for (const k2 of keys) {
                            value = value?.[k2];
                        }
                        break;
                    }
                }
                
                // Replace placeholders if any
                if (typeof value === 'string') {
                    Object.keys(replacements).forEach(placeholder => {
                        value = value.replace(`{${placeholder}}`, replacements[placeholder]);
                    });
                }
                
                return value || key;
            }
            
            setLanguage(lang) {
                if (!this.languages[lang]) return;
                
                this.currentLang = lang;
                localStorage.setItem('app-language', lang);
                this.updatePageLanguage();
                this.updateUI();
                
                // Update HTML lang attribute
                document.documentElement.lang = lang;
                
                // Update current language flag
                document.getElementById('currentLangFlag').textContent = this.languages[lang].flag;
                
                // Update active state in dropdown
                document.querySelectorAll('#langDropdown button').forEach(btn => {
                    const btnLang = btn.onclick.toString().match(/changeLanguage\('(\w+)'\)/)?.[1];
                    btn.classList.toggle('active', btnLang === lang);
                });
                
                // Refresh current view
                if (app.currentView === 'list' || app.currentView === 'favorites') {
                    updateListView(app.currentView === 'favorites');
                }
                
                // Close popups to refresh content
                if (app.map) {
                    app.map.closePopup();
                }
            }
            
            updatePageLanguage() {
                document.documentElement.lang = this.currentLang;
                document.getElementById('currentLangFlag').textContent = this.languages[this.currentLang].flag;
            }
            
            updateUI() {
                // Update all elements with data-i18n
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = this.get(key);
                });
                
                // Update all elements with data-i18n-html (for content with HTML)
                document.querySelectorAll('[data-i18n-html]').forEach(el => {
                    const key = el.getAttribute('data-i18n-html');
                    el.innerHTML = this.get(key);
                });
                
                // Update placeholders
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = this.get(key);
                });
                
                // Update aria-labels
                document.querySelectorAll('[data-i18n-aria]').forEach(el => {
                    const key = el.getAttribute('data-i18n-aria');
                    el.setAttribute('aria-label', this.get(key));
                });
                
                // Update title attributes
                document.querySelectorAll('[data-i18n-title]').forEach(el => {
                    const key = el.getAttribute('data-i18n-title');
                    el.setAttribute('title', this.get(key));
                });
                
                // Update page title
                document.title = this.get('header.title').replace('🎪 ', '');
            }
        }

        // Initialize language manager
        const lang = new LanguageManager();

        // App state
        const app = {
            map: null,
            markers: [],
            markerCluster: null,
            userMarker: null,
            userLocation: null,
            currentView: 'map',
            favorites: JSON.parse(localStorage.getItem('sagre-favorites') || '[]'),
            filters: {
                search: '',
                categories: [],
                dateFrom: null,
                dateTo: null
            },
            sagre: [],
            lang: lang
        };

        // Sagre data with translations (showing example structure)
        app.sagre = [
            {
                name: "Collesanto Antria in Gastronomia",
                location: "Antria (PG)",
                coords: [43.139, 12.251],
                startDate: "2025-07-11",
                endDate: "2025-07-20",
                food: "Oca in porchetta, piatti tipici della tradizione contadina",
                description: "38ª edizione nel castello medievale di Antria",
                url: "https://www.umbriaeventi.com/collesanto-antria-in-gastronomia-sagra-dell-oca-antria-8460.htm",
                category: "carne",
                translations: {
                    en: {
                        food: "Roasted goose, traditional countryside dishes",
                        description: "38th edition in the medieval castle of Antria"
                    },
                    nl: {
                        food: "Geroosterde gans, traditionele plattelandsgerechten",
                        description: "38e editie in het middeleeuwse kasteel van Antria"
                    },
                    de: {
                        food: "Gebratene Gans, traditionelle Landgerichte",
                        description: "38. Ausgabe im mittelalterlichen Schloss von Antria"
                    },
                    fr: {
                        food: "Oie rôtie, plats traditionnels de la campagne",
                        description: "38e édition dans le château médiéval d'Antria"
                    }
                }
            },
            {
                name: "Sagra dei Bringoli",
                location: "Lisciano Niccone (PG)",
                coords: [43.245, 12.095],
                startDate: "2025-07-17",
                endDate: "2025-07-20",
                food: "Bringoli (spaghetti di grandi dimensioni)",
                description: "48ª edizione con musica e ottima cucina",
                url: "https://www.umbriaeventi.com/sagra-dei-bringoli-lisciano-niccone-8374.htm",
                category: "pasta",
                translations: {
                    en: {
                        name: "Bringoli Festival",
                        food: "Bringoli (large spaghetti)",
                        description: "48th edition with music and excellent cuisine"
                    },
                    nl: {
                        name: "Bringoli Festival",
                        food: "Bringoli (grote spaghetti)",
                        description: "48e editie met muziek en uitstekende keuken"
                    },
                    de: {
                        name: "Bringoli Fest",
                        food: "Bringoli (große Spaghetti)",
                        description: "48. Ausgabe mit Musik und ausgezeichneter Küche"
                    },
                    fr: {
                        name: "Festival des Bringoli",
                        food: "Bringoli (grandes pâtes)",
                        description: "48e édition avec musique et cuisine excellente"
                    }
                }
            },
            // Add remaining sagre with same structure...
            // For brevity, I'll add the rest without translations but they would follow the same pattern
            { name: "Sagra del Brustico e del Prosciutto e Melone", location: "Villastrada (PG)", coords: [43.025, 12.089], startDate: "2025-07-16", endDate: "2025-07-20", food: "Brustico, prosciutto e melone", description: "33ª edizione presso il Club Sportivo Villastrada", url: "https://www.umbriaeventi.com/sagra-del-brustico-e-del-prosciutto-e-melone-villastrada-8788.htm", category: "carne" },
            { name: "Sagra degli Arrosticini", location: "Guardea (TR)", coords: [42.625, 12.295], startDate: "2025-07-18", endDate: "2025-07-27", food: "Arrosticini di carne", description: "8ª edizione presso Piazza Panfili", url: "https://www.umbriaeventi.com/festa-degli-arrosticini-guardea-terni-13308.htm", category: "carne" },
            { name: "Sagra della Pecora", location: "Civita Castellana (VT)", coords: [42.293, 12.414], startDate: "2025-07-18", endDate: "2025-07-20", food: "Piatti a base di pecora", description: "14ª edizione con musica e spettacoli", url: "https://www.umbriaeventi.com/sagra-della-pecora-fabrica-di-roma-13391.htm", category: "carne" },
            { name: "Sagra del Buon Mangiare", location: "Villa San Faustino (PG)", coords: [42.776, 12.669], startDate: "2025-07-18", endDate: "2025-07-27", food: "Cucina tradizionale locale", description: "37ª edizione nel borgo storico", url: "https://www.umbriaeventi.com/sagra-del-buon-mangiare-villa-san-faustino-8138.htm", category: "altro" },
            { name: "Castellonando", location: "Castellonalto (TR)", coords: [42.521, 12.771], startDate: "2025-07-18", endDate: "2025-07-27", food: "Percorso enogastronomico con 5 postazioni", description: "17ª edizione nel borgo a 664m slm", url: "https://www.umbriaeventi.com/feste_paesane_castellonando_2014_castellonalto_8426.htm", category: "altro" },
            { name: "Sagra del Baccalà", location: "Bomarzo (VT)", coords: [42.485, 12.249], startDate: "2025-07-18", endDate: "2025-08-03", food: "Baccalà in varie declinazioni", description: "13ª edizione per riscoprire i sapori di una volta", url: "https://www.umbriaeventi.com/sagra-del-baccala-bomarzo-12634.htm", category: "pesce" },
            { name: "Sagra dell'Oca", location: "Castel Cellesi (VT)", coords: [42.445, 12.302], startDate: "2025-07-23", endDate: "2025-07-27", food: "Piatti a base di oca", description: "2ª edizione con musica dal vivo", url: "https://www.umbriaeventi.com/sagra-dell-oca-castel-cellesi-15585.htm", category: "carne" },
            { name: "In Piazza Sotto le Stelle", location: "Deruta (PG)", coords: [42.981, 12.419], startDate: "2025-07-24", endDate: "2025-08-02", food: "Vari piatti della tradizione", description: "Musica, ceramica e cultura in Piazza dei Consoli", url: "https://www.umbriaeventi.com/in-piazza-sotto-le-stelle-deruta-10262.htm", category: "altro" },
            { name: "Settimana Gastronomica - Sagra dell'Oca Arrosto", location: "Torchiagina (PG)", coords: [43.025, 12.613], startDate: "2025-07-25", endDate: "2025-08-03", food: "Oca arrosto e cucina tipica", description: "53ª edizione con serate danzanti", url: "https://www.umbriaeventi.com/settimana-gastronomica-torchiaginese-sagra-dell-oca-arrosto-torchiagina-8472.htm", category: "carne" },
            { name: "Sagra del Piccione", location: "Montecchio di Cortona (AR)", coords: [43.194, 11.987], startDate: "2025-07-25", endDate: "2025-08-03", food: "Piccione al girarrosto sulla brace", description: "50ª edizione presso il Campo Sportivo", url: "https://www.umbriaeventi.com/sagra-del-piccione-montecchio-di-cortona-13910.htm", category: "carne" },
            { name: "Sagra della Pizza al Forno", location: "Ponte San Lorenzo di Narni (TR)", coords: [42.507, 12.511], startDate: "2025-07-25", endDate: "2025-08-03", food: "Pizza al forno", description: "10 serate con musica live e area bimbi", url: "https://www.umbriaeventi.com/sagra-della-pizza-al-forno-ponte-san-lorenzo-di-narni-8871.htm", category: "altro" },
            { name: "Sagra dell'Oca", location: "Bettona (PG)", coords: [43.011, 12.485], startDate: "2025-07-25", endDate: "2025-08-03", food: "Ricette tradizionali a base di oca", description: "41ª edizione presso i Giardini di Santa Caterina", url: "https://www.umbriaeventi.com/sagra-dell-oca-bettona-8643.htm", category: "carne" },
            { name: "Sagra del Berlingozzo", location: "Pitigliano (PG)", coords: [42.852, 12.106], startDate: "2025-07-25", endDate: "2025-07-27", food: "Berlingozzo (ciambella all'anice)", description: "48ª edizione della festa tradizionale", url: "https://www.umbriaeventi.com/sagra-del-berlingozzo-pitigliano-8681.htm", category: "dolci" },
            { name: "Sagra de u Cecu Maritu", location: "Aguzzo (TR)", coords: [42.485, 12.667], startDate: "2025-07-25", endDate: "2025-08-03", food: "Cecu Maritu (focaccia farcita con erbe)", description: "13ª edizione con storia curiosa sul nome", url: "https://www.umbriaeventi.com/sagra-de-u-cecu-maritu-aguzzo-8205.htm", category: "altro" },
            { name: "Serate Medievali", location: "Itieli (TR)", coords: [42.627, 12.544], startDate: "2025-07-25", endDate: "2025-07-26", food: "Cucina medievale", description: "Rievocazioni storiche nel castello", url: "https://www.umbriaeventi.com/serate-medievali-itieli-10590.htm", category: "altro" },
            { name: "Note di Luppolo", location: "San Martino al Cimino (VT)", coords: [42.370, 12.173], startDate: "2025-07-25", endDate: "2025-07-27", food: "Birra artigianale e street food", description: "8ª edizione dedicata alla birra artigianale", url: "https://www.umbriaeventi.com/note-di-luppolo-san-martino-al-cimino-12777.htm", category: "altro" },
            { name: "Sagra della Patata", location: "Giacconale (PG)", coords: [43.362, 12.734], startDate: "2025-07-26", endDate: "2025-07-27", food: "Piatti a base di patate", description: "1ª edizione con chef campani", url: "https://www.umbriaeventi.com/sagra-della-patata-sigillo-15868.htm", category: "verdure" },
            { name: "Ferragosto Toreggiano", location: "Tuoro sul Trasimeno (PG)", coords: [43.212, 12.077], startDate: "2025-08-01", endDate: "2025-08-15", food: "Piatti prelibati della tradizione", description: "Rievocazioni storiche e cena storica romana", url: "https://www.umbriaeventi.com/ferragosto-toreggiano-tuoro-sul-trasimeno-8383.htm", category: "altro" },
            { name: "Sagra della Lumaca", location: "Cancelli (AN)", coords: [43.472, 12.904], startDate: "2025-07-31", endDate: "2025-08-03", food: "Lumache", description: "41ª edizione in località storica", url: "https://www.umbriaeventi.com/sagra-della-lumaca-cancelli-11643.htm", category: "carne" },
            { name: "Sagra del Cavatello", location: "Vitorchiano (VT)", coords: [42.468, 12.174], startDate: "2025-07-31", endDate: "2025-08-03", food: "Cavatello (pasta fresca tipica)", description: "44ª edizione nel borgo medievale", url: "https://www.umbriaeventi.com/sagra-del-cavatello-vitorchiano-14069.htm", category: "pasta" },
            { name: "Sagra degli Gnocchi", location: "Guardea (TR)", coords: [42.625, 12.295], startDate: "2025-08-01", endDate: "2025-08-10", food: "Gnocchi", description: "35ª edizione, uno degli appuntamenti più attesi", url: "https://www.umbriaeventi.com/sagra-degli-gnocchi-guardea-8012.htm", category: "pasta" },
            { name: "Sagra della Torta al Testo", location: "Sant'Egidio (PG)", coords: [43.071, 12.430], startDate: "2025-08-01", endDate: "2025-08-10", food: "Torta al testo cotta sotto la cenere", description: "52ª edizione dell'appuntamento estivo", url: "https://www.umbriaeventi.com/sagra-della-torta-al-testo-sant-egidio-8136.htm", category: "altro" },
            { name: "Sagra dello Gnocco", location: "Pieve di Compresseto (PG)", coords: [43.025, 12.567], startDate: "2025-08-01", endDate: "2025-08-03", food: "Gnocchi fatti a mano", description: "32ª edizione con partecipazione di tutto il paese", url: "https://www.umbriaeventi.com/sagra-dello-gnocco-pieve-di-compresseto-9060.htm", category: "pasta" },
            { name: "Vinotricolando", location: "Otricoli (TR)", coords: [42.419, 12.482], startDate: "2025-08-01", endDate: "2025-08-03", food: "Vino e gastronomia del territorio", description: "Viaggio enogastronomico nei vicoli nascosti", url: "https://www.umbriaeventi.com/vinotricolando-otricoli-8867.htm", category: "vino" },
            { name: "Ferragosto a Quadrelli - Sagra della Rana Fritta", location: "Quadrelli (TR)", coords: [42.748, 12.394], startDate: "2025-08-06", endDate: "2025-08-15", food: "Rana fritta e piatti tradizionali", description: "Festa dell'Assunta con tradizioni secolari", url: "https://www.umbriaeventi.com/ferragosto-a-quadrelli-sagra-rana-fritta-8142.htm", category: "carne" },
            { name: "Sagra della Porchetta e dei Fagioli con le Cotiche", location: "Monte Santa Maria Tiberina (PG)", coords: [43.433, 12.127], startDate: "2025-08-07", endDate: "2025-08-10", food: "Porchetta e fagioli con le cotiche", description: "31ª edizione nel borgo medievale", url: "https://www.umbriaeventi.com/sagra-della-porchetta-e-dei-fagioli-con-le-cotiche-monte-santa-maria-tiberina-8688.htm", category: "carne" },
            { name: "Sagra della Tagliatella Casareccia", location: "Lisciano Niccone (PG)", coords: [43.245, 12.095], startDate: "2025-08-08", endDate: "2025-08-17", food: "Tagliatella casareccia", description: "49ª edizione nella Val di Pierle", url: "https://www.umbriaeventi.com/sagra-della-tagliatella-casareccia-lisciano-niccone-10716.htm", category: "pasta" },
            { name: "Aperissima", location: "Capocavallo (PG)", coords: [43.069, 12.359], startDate: "2025-08-08", endDate: "2025-08-17", food: "Sangria, stinco e menù ricco", description: "50 anni della Pro Loco Aper90", url: "https://www.umbriaeventi.com/aperissima-sagra-della-sangria-e-dello-stinco-capocavallo-6377.htm", category: "carne" },
            { name: "Sagra del Fungo", location: "Pianello (PG)", coords: [43.105, 12.467], startDate: "2025-08-08", endDate: "2025-08-17", food: "Funghi e piatti della tradizione", description: "45ª edizione con musica e ottima cucina", url: "https://www.umbriaeventi.com/sagra-del-fungo-pianello-8413.htm", category: "verdure" },
            { name: "Sagra della Cannelletta", location: "Castel Viscardo (TR)", coords: [42.758, 12.003], startDate: "2025-08-09", endDate: "2025-08-18", food: "Cannelletta e prodotti locali", description: "57ª edizione con tradizione enogastronomica", url: "https://www.umbriaeventi.com/sagra-della-cannelletta-castel-viscardo-8988.htm", category: "altro" }
        ];

        // Town coordinates
        const townCoordinates = {
            'todi': [42.781, 12.407],
            'perugia': [43.110, 12.390],
            'assisi': [43.070, 12.620],
            'spoleto': [42.740, 12.740],
            'terni': [42.563, 12.643],
            'orvieto': [42.719, 12.110],
            'gubbio': [43.351, 12.577],
            'foligno': [42.956, 12.703],
            'città di castello': [43.456, 12.238],
            'citta di castello': [43.456, 12.238],
            'narni': [42.517, 12.516],
            'amelia': [42.556, 12.413],
            'spello': [42.990, 12.670],
            'bevagna': [42.932, 12.609],
            'montefalco': [42.892, 12.650],
            'norcia': [42.793, 13.093],
            'castiglione del lago': [43.126, 12.055],
            'marsciano': [42.909, 12.337],
            'umbertide': [43.305, 12.330],
            'bastia umbra': [43.068, 12.549],
            'corciano': [43.128, 12.301],
            'cortona': [43.275, 11.988],
            'arezzo': [43.463, 11.880],
            'viterbo': [42.420, 12.108],
            'roma': [41.902, 12.496],
            'rome': [41.902, 12.496],
            'siena': [43.318, 11.331],
            'firenze': [43.769, 11.256],
            'florence': [43.769, 11.256],
            'rieti': [42.404, 12.856],
            // Add international cities for non-Italian users
            'amsterdam': [52.370, 4.895],
            'berlin': [52.520, 13.405],
            'paris': [48.856, 2.352],
            'london': [51.507, -0.127],
            'brussels': [50.850, 4.351]
        };

        // Helper function to get translated sagra fields
        function getSagraField(sagra, field) {
            const currentLang = app.lang.currentLang;
            if (currentLang !== 'it' && sagra.translations && sagra.translations[currentLang]) {
                return sagra.translations[currentLang][field] || sagra[field];
            }
            return sagra[field];
        }

        // Language dropdown toggle
        function toggleLanguageMenu() {
            const dropdown = document.getElementById('langDropdown');
            dropdown.classList.toggle('active');
        }

        // Change language
        function changeLanguage(newLang) {
            app.lang.setLanguage(newLang);
            toggleLanguageMenu();
            showToast(lang.get('toast.languageChanged'));
        }

        // Close language dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('langDropdown').classList.remove('active');
            }
        });

        // Initialize map
        function initMap() {
            app.map = L.map('map').setView([42.9, 12.4], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(app.map);

            // Initialize marker cluster group
            app.markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                maxClusterRadius: 50
            });

            createMarkers();
            app.map.addLayer(app.markerCluster);
        }

        // Create markers with custom icons
        function createMarkers() {
            const today = new Date();
            
            app.sagre.forEach(sagra => {
                const startDate = new Date(sagra.startDate);
                const endDate = new Date(sagra.endDate);
                const isActive = today >= startDate && today <= endDate;
                const isPast = today > endDate;
                
                // Custom icon based on status
                const iconHtml = `
                    <div style="
                        background: ${isPast ? '#9ca3af' : isActive ? '#10b981' : '#6366f1'};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                    ">
                        ${getCategoryEmoji(sagra.category)}
                    </div>
                `;
                
                const customIcon = L.divIcon({
                    html: iconHtml,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -30],
                    className: 'custom-marker'
                });

                const marker = L.marker(sagra.coords, { icon: customIcon })
                    .bindPopup(() => createPopupContent(sagra));
                
                marker.sagraData = sagra;
                app.markers.push(marker);
                app.markerCluster.addLayer(marker);
            });
        }

        // Get category emoji
        function getCategoryEmoji(category) {
            const emojis = {
                pasta: '🍝',
                carne: '🥩',
                pesce: '🐟',
                dolci: '🍰',
                verdure: '🥗',
                formaggi: '🧀',
                vino: '🍷',
                altro: '🍽️'
            };
            return emojis[category] || '🍽️';
        }

        // Create popup content
        function createPopupContent(sagra) {
            const isFavorite = app.favorites.includes(sagra.name);
            const distance = app.userLocation ? 
                calculateDistance(app.userLocation[0], app.userLocation[1], sagra.coords[0], sagra.coords[1]) : null;
            
            return `
                <div class="popup-header">
                    <h3>${getSagraField(sagra, 'name')}</h3>
                    <div class="popup-location">📍 ${sagra.location}</div>
                </div>
                <div class="popup-body">
                    <div class="popup-meta">
                        <div class="popup-meta-item">
                            📅 ${formatDateLocalized(sagra.startDate)} - ${formatDateLocalized(sagra.endDate)}
                        </div>
                        <div class="popup-meta-item" style="color: var(--success);">
                            🍽️ ${getSagraField(sagra, 'food')}
                        </div>
                        ${distance ? `
                            <div class="popup-meta-item">
                                📏 ${formatDistance(distance)} ${lang.get('common.fromYourLocation')}
                            </div>
                        ` : ''}
                        <div class="popup-meta-item">
                            📝 ${getSagraField(sagra, 'description')}
                        </div>
                    </div>
                    <div class="popup-actions">
                        <button class="btn btn-secondary" onclick="toggleFavorite('${sagra.name}')">
                            ${isFavorite ? lang.get('actions.removeFromFavorites') : lang.get('actions.addToFavorites')}
                        </button>
                        <a href="${sagra.url}" target="_blank" class="btn btn-secondary">
                            🔗 ${lang.get('actions.moreInfo')}
                        </a>
                    </div>
                </div>
            `;
        }

        // Format date based on locale
        function formatDateLocalized(dateString) {
            const date = new Date(dateString);
            const currentLang = app.lang.currentLang;
            
            const locales = {
                it: 'it-IT',
                en: 'en-US',
                nl: 'nl-NL',
                de: 'de-DE',
                fr: 'fr-FR'
            };
            
            return date.toLocaleDateString(locales[currentLang], {
                day: 'numeric',
                month: 'short'
            });
        }

        // Format distance based on locale
        function formatDistance(km) {
            const currentLang = app.lang.currentLang;
            
            // Convert to miles for English
            if (currentLang === 'en') {
                const miles = km * 0.621371;
                return `${miles.toFixed(1)} mi`;
            }
            
            return `${km.toFixed(1)} km`;
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Show view (map/list/favorites)
        function showView(view) {
            app.currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            if (view === 'map') {
                document.getElementById('navMap').classList.add('active');
                document.getElementById('map').style.display = 'block';
                document.getElementById('listView').classList.remove('active');
                setTimeout(() => app.map.invalidateSize(), 100);
            } else if (view === 'list') {
                document.getElementById('navList').classList.add('active');
                document.getElementById('map').style.display = 'none';
                document.getElementById('listView').classList.add('active');
                updateListView();
            } else if (view === 'favorites') {
                document.getElementById('navFavorites').classList.add('active');
                document.getElementById('map').style.display = 'none';
                document.getElementById('listView').classList.add('active');
                updateListView(true);
            }
        }

        // Update list view
        function updateListView(favoritesOnly = false) {
            const listContent = document.getElementById('listContent');
            let sagre = app.sagre;
            
            // Filter by favorites if needed
            if (favoritesOnly) {
                sagre = sagre.filter(s => app.favorites.includes(s.name));
            }
            
            // Apply other filters
            sagre = applyFiltersToSagre(sagre);
            
            // Sort by date or distance
            if (app.userLocation) {
                sagre.sort((a, b) => {
                    const distA = calculateDistance(app.userLocation[0], app.userLocation[1], a.coords[0], a.coords[1]);
                    const distB = calculateDistance(app.userLocation[0], app.userLocation[1], b.coords[0], b.coords[1]);
                    return distA - distB;
                });
            } else {
                sagre.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            }
            
            // Generate HTML
            if (sagre.length === 0) {
                listContent.innerHTML = `
                    <div class="no-results">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <p>${favoritesOnly ? lang.get('common.noFavorites') : lang.get('common.noResults')}</p>
                    </div>
                `;
                return;
            }
            
            listContent.innerHTML = sagre.map(sagra => {
                const isFavorite = app.favorites.includes(sagra.name);
                const distance = app.userLocation ? 
                    calculateDistance(app.userLocation[0], app.userLocation[1], sagra.coords[0], sagra.coords[1]) : null;
                
                return `
                    <div class="list-card ${isFavorite ? 'favorite' : ''}" onclick="focusOnSagra(${sagra.coords[0]}, ${sagra.coords[1]})">
                        <div class="list-card-header">
                            <div>
                                <h3>${getSagraField(sagra, 'name')}</h3>
                                <div class="list-card-meta">
                                    <span>📍 ${sagra.location}</span>
                                    <span>📅 ${formatDateLocalized(sagra.startDate)} - ${formatDateLocalized(sagra.endDate)}</span>
                                    ${distance ? `<span>📏 ${formatDistance(distance)}</span>` : ''}
                                </div>
                                <div class="list-card-food">${getCategoryEmoji(sagra.category)} ${getSagraField(sagra, 'food')}</div>
                            </div>
                            <button class="favorite-button ${isFavorite ? 'active' : ''}" 
                                    onclick="event.stopPropagation(); toggleFavorite('${sagra.name}')">
                                ${isFavorite ? '❤️' : '🤍'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Apply filters to sagre
        function applyFiltersToSagre(sagre) {
            let filtered = sagre;
            
            // Search filter
            if (app.filters.search) {
                const search = app.filters.search.toLowerCase();
                filtered = filtered.filter(s => 
                    getSagraField(s, 'name').toLowerCase().includes(search) ||
                    s.location.toLowerCase().includes(search) ||
                    getSagraField(s, 'food').toLowerCase().includes(search)
                );
            }
            
            // Category filter
            if (app.filters.categories.length > 0) {
                filtered = filtered.filter(s => app.filters.categories.includes(s.category));
            }
            
            // Date filter
            if (app.filters.dateFrom || app.filters.dateTo) {
                filtered = filtered.filter(s => {
                    const startDate = new Date(s.startDate);
                    const endDate = new Date(s.endDate);
                    
                    if (app.filters.dateFrom && app.filters.dateTo) {
                        const filterFrom = new Date(app.filters.dateFrom);
                        const filterTo = new Date(app.filters.dateTo);
                        return (startDate >= filterFrom && startDate <= filterTo) ||
                               (endDate >= filterFrom && endDate <= filterTo) ||
                               (startDate <= filterFrom && endDate >= filterTo);
                    } else if (app.filters.dateFrom) {
                        const filterFrom = new Date(app.filters.dateFrom);
                        return endDate >= filterFrom;
                    } else if (app.filters.dateTo) {
                        const filterTo = new Date(app.filters.dateTo);
                        return startDate <= filterTo;
                    }
                });
            }
            
            return filtered;
        }

        // Focus on sagra
        function focusOnSagra(lat, lng) {
            showView('map');
            app.map.setView([lat, lng], 14);
            
            // Find and open popup
            app.markers.forEach(marker => {
                if (marker.sagraData.coords[0] === lat && marker.sagraData.coords[1] === lng) {
                    app.markerCluster.zoomToShowLayer(marker, () => {
                        marker.openPopup();
                    });
                }
            });
        }

        // Toggle favorite
        function toggleFavorite(sagraName) {
            const index = app.favorites.indexOf(sagraName);
            if (index > -1) {
                app.favorites.splice(index, 1);
                showToast(lang.get('toast.removedFromFavorites'));
            } else {
                app.favorites.push(sagraName);
                showToast(lang.get('toast.addedToFavorites'));
            }
            
            localStorage.setItem('sagre-favorites', JSON.stringify(app.favorites));
            updateFavoritesCount();
            
            // Refresh current view
            if (app.currentView === 'list' || app.currentView === 'favorites') {
                updateListView(app.currentView === 'favorites');
            }
            
            // Refresh popups
            app.map.closePopup();
        }

        // Update favorites count
        function updateFavoritesCount() {
            const count = app.favorites.length;
            const badge = document.getElementById('favoritesCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show near me
        function showNearMe() {
            if (!app.userLocation) {
                useGPS();
                return;
            }
            
            showView('list');
            updateListView();
        }

        // Toggle filter sheet
        function toggleFilterSheet() {
            const sheet = document.getElementById('filterSheet');
            const backdrop = document.getElementById('backdrop');
            
            if (sheet.classList.contains('active')) {
                closeFilterSheet();
            } else {
                sheet.classList.add('active');
                backdrop.classList.add('active');
            }
        }

        // Close filter sheet
        function closeFilterSheet() {
            document.getElementById('filterSheet').classList.remove('active');
            document.getElementById('backdrop').classList.remove('active');
        }

        // Handle search
        function handleSearch(value) {
            app.filters.search = value;
            updateFilterBadge();
        }

        // Toggle category
        function toggleCategory(chip) {
            const category = chip.dataset.category;
            chip.classList.toggle('active');
            
            const index = app.filters.categories.indexOf(category);
            if (index > -1) {
                app.filters.categories.splice(index, 1);
            } else {
                app.filters.categories.push(category);
            }
            
            updateFilterBadge();
        }

        // Update date filter
        function updateDateFilter() {
            app.filters.dateFrom = document.getElementById('dateFrom').value;
            app.filters.dateTo = document.getElementById('dateTo').value;
            updateFilterBadge();
        }

        // Update filter badge
        function updateFilterBadge() {
            let count = 0;
            if (app.filters.search) count++;
            if (app.filters.categories.length > 0) count++;
            if (app.filters.dateFrom || app.filters.dateTo) count++;
            
            const badge = document.getElementById('filterBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Apply filters
        function applyFilters() {
            // Update markers on map
            app.markerCluster.clearLayers();
            const filteredSagre = applyFiltersToSagre(app.sagre);
            
            app.markers.forEach(marker => {
                if (filteredSagre.includes(marker.sagraData)) {
                    app.markerCluster.addLayer(marker);
                }
            });
            
            // Update list view if active
            if (app.currentView === 'list') {
                updateListView();
            }
            
            closeFilterSheet();
            showToast(`${filteredSagre.length} ${lang.get('toast.resultsFound')}`);
        }

        // Reset filters
        function resetFilters() {
            app.filters = {
                search: '',
                categories: [],
                dateFrom: null,
                dateTo: null
            };
            
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            
            updateFilterBadge();
            applyFilters();
        }

        // Set user location
        function setUserLocation() {
            const input = document.getElementById('locationInput').value.toLowerCase().trim();
            if (!input) {
                showToast(lang.get('toast.enterCity'));
                return;
            }
            
            const coords = townCoordinates[input];
            if (!coords) {
                showToast(lang.get('toast.locationNotFound'));
                return;
            }
            
            updateUserLocation(coords, input);
            closeFilterSheet();
        }

        // Use GPS
        function useGPS() {
            if (!navigator.geolocation) {
                showToast(lang.get('toast.geolocationNotSupported'));
                return;
            }
            
            showToast(lang.get('toast.detectingLocation'));
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    updateUserLocation(coords, 'GPS');
                    showToast(lang.get('toast.locationDetected'));
                },
                error => {
                    showToast(lang.get('toast.locationError'));
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Update user location
        function updateUserLocation(coords, label) {
            app.userLocation = coords;
            
            // Remove old marker
            if (app.userMarker) {
                app.map.removeLayer(app.userMarker);
            }
            
            // Add new marker
            const userIcon = L.divIcon({
                html: '<div style="background: #ef4444; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">📍</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            app.userMarker = L.marker(coords, { icon: userIcon })
                .bindPopup(`<strong>${lang.get('filters.myLocation')}: ${label}</strong>`)
                .addTo(app.map);
            
            app.map.setView(coords, 10);
            
            // Update list if active
            if (app.currentView === 'list') {
                updateListView();
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            // Store as string 'true' or 'false' to handle default dark mode
            localStorage.setItem('darkMode', isDark.toString());
            
            // Update theme-color meta tag
            const themeColor = document.querySelector('meta[name="theme-color"]');
            if (themeColor) {
                themeColor.content = isDark ? '#1f2937' : '#6366f1';
            }
            
            showToast(isDark ? lang.get('toast.darkModeOn') : lang.get('toast.darkModeOff'));
        }

        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Disclaimer functions
        function showDisclaimer() {
            const backdrop = document.getElementById('disclaimerBackdrop');
            backdrop.classList.add('active');
        }

        function closeDisclaimer() {
            const backdrop = document.getElementById('disclaimerBackdrop');
            backdrop.classList.remove('active');
            // Mark as seen
            localStorage.setItem('disclaimer-seen', 'true');
        }

        // Close disclaimer when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            const disclaimerBackdrop = document.getElementById('disclaimerBackdrop');
            if (disclaimerBackdrop) {
                disclaimerBackdrop.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeDisclaimer();
                    }
                });
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check dark mode preference - default to true (dark mode)
            const isDarkMode = localStorage.getItem('darkMode') !== 'false';
            if (!isDarkMode) {
                document.body.classList.remove('dark-mode');
                // Update theme-color for light mode
                const themeColor = document.querySelector('meta[name="theme-color"]');
                if (themeColor) {
                    themeColor.content = '#6366f1';
                }
            }
            
            // Initialize language UI
            app.lang.updateUI();
            
            // Initialize map
            initMap();
            
            // Update favorites count
            updateFavoritesCount();
            
            // Show disclaimer on first visit
            if (!localStorage.getItem('disclaimer-seen')) {
                setTimeout(() => {
                    showDisclaimer();
                }, 500);
            }
            
            // Add swipe gesture for filter sheet
            let touchStartY = 0;
            const sheet = document.getElementById('filterSheet');
            
            sheet.addEventListener('touchstart', e => {
                touchStartY = e.touches[0].clientY;
            });
            
            sheet.addEventListener('touchmove', e => {
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                
                if (deltaY > 50) {
                    closeFilterSheet();
                }
            });
            
            // Close disclaimer with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const disclaimer = document.getElementById('disclaimerBackdrop');
                    if (disclaimer.classList.contains('active')) {
                        closeDisclaimer();
                    }
                }
            });
        });
    </script>
</body>
</html>
